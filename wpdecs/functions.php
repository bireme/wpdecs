<?php

$QUALIFIER_LIST = array(
    'p' => array("AB"=>"anormalidades", "AD"=>"administração & dosagem", "AE"=>"efeitos adversos", "AG"=>"agonistas", "AA"=>"análogos & derivados", "AN"=>"análise", "AH"=>"anatomia & histologia", "AI"=>"antagonistas & Inibidores", "BI"=>"biossíntese", "BL"=>"sangue", "BS"=>"irrigação sanguínea", "CF"=>"líquido céfalo-raquidiano", "CS"=>"síntese química", "CI"=>"induzido quimicamente", "CH"=>"química", "CL"=>"classificação", "CO"=>"complicações", "CN"=>"congênito", "CT"=>"contra-indicações", "CY"=>"citologia", "DF"=>"deficiência", "DI"=>"diagnóstico", "DU"=>"uso diagnóstico", "DH"=>"dietoterapia", "DE"=>"efeitos de drogas", "DT"=>"quimioterapia", "EC"=>"economia", "ED"=>"educação", "EM"=>"embriologia", "EN"=>"enzimologia", "EP"=>"epidemiologia", "ES"=>"ética", "EH"=>"etnologia", "ET"=>"etiologia", "GE"=>"genética", "GD"=>"crescimento & desenvolvimento", "HI"=>"história", "IM"=>"imunologia", "IN"=>"lesões", "IR"=>"inervação", "IS"=>"instrumentação", "IP"=>"isolamento & purificação", "LJ"=>"legislação & jurisprudência", "MA"=>"recursos humanos", "ME"=>"metabolismo", "MT"=>"métodos", "MI"=>"microbiologia", "MO"=>"mortalidade", "NU"=>"enfermagem", "OG"=>"organização & administração", "PS"=>"parasitologia", "PY"=>"patogenicidade", "PA"=>"patologia", "PK"=>"farmacocinética", "PD"=>"farmacologia", "PH"=>"fisiologia", "PP"=>"fisiopatologia", "PO"=>"envenenamento", "PL"=>"políticas", "PC"=>"prevenção & controle", "PX"=>"psicologia", "RE"=>"efeitos de radiação", "RA"=>"radiografia", "RI"=>"cintilografia", "RT"=>"radioterapia", "RH"=>"reabilitação", "SC"=>"secundário", "SE"=>"secreção", "ST"=>"normas", "SN"=>"estatística & dados numéricos", "SD"=>"provisão & distribuição", "SU"=>"cirurgia", "TU"=>"uso terapêutico", "TH"=>"terapia", "TO"=>"toxicidade", "TM"=>"transmissão", "TR"=>"transplante", "TD"=>"tendências", "US"=>"ultrasonografia", "UL"=>"ultraestrutura", "UR"=>"urina", "UT"=>"utilização", "VE"=>"veterinária", "VI"=>"virologia",),
    'i' => array("AB"=>"abnormalities", "AD"=>"administration & dosage", "AE"=>"adverse effects", "AG"=>"agonists", "AA"=>"analogs & derivatives", "AN"=>"analysis", "AH"=>"anatomy & histology", "AI"=>"antagonists & inhibitors", "BI"=>"biosynthesis", "BL"=>"blood", "BS"=>"blood supply", "CF"=>"cerebrospinal fluid", "CS"=>"chemical synthesis", "CI"=>"chemically induced", "CH"=>"chemistry", "CL"=>"classification", "CO"=>"complications", "CN"=>"congenital", "CT"=>"contraindications", "CY"=>"cytology", "DF"=>"deficiency", "DI"=>"diagnosis", "DU"=>"diagnostic use", "DH"=>"diet therapy", "DE"=>"drug effects", "DT"=>"drug therapy", "EC"=>"economics", "ED"=>"education", "EM"=>"embryology", "EN"=>"enzymology", "EP"=>"epidemiology", "ES"=>"ethics", "EH"=>"ethnology", "ET"=>"etiology", "GE"=>"genetics", "GD"=>"growth & development", "HI"=>"history", "IM"=>"immunology", "IN"=>"injuries", "IR"=>"innervation", "IS"=>"instrumentation", "IP"=>"isolation & purification", "LJ"=>"legislation & jurisprudence", "MA"=>"manpower", "ME"=>"metabolism", "MT"=>"methods", "MI"=>"microbiology", "MO"=>"mortality", "NU"=>"nursing", "OG"=>"organization & administration", "PS"=>"parasitology", "PY"=>"pathogenicity", "PA"=>"pathology", "PK"=>"pharmacokinetics", "PD"=>"pharmacology", "PH"=>"physiology", "PP"=>"physiopathology", "PO"=>"poisoning", "PL"=>"policies", "PC"=>"prevention & control", "PX"=>"psychology", "RE"=>"radiation effects", "RA"=>"radiography", "RI"=>"radionuclide imaging", "RT"=>"radiotherapy", "RH"=>"rehabilitation", "SC"=>"secondary", "SE"=>"secretion", "ST"=>"standards", "SN"=>"statistics & numerical data", "SD"=>"supply & distribution", "SU"=>"surgery", "TU"=>"therapeutic use", "TH"=>"therapy", "TO"=>"toxicity", "TM"=>"transmission", "TR"=>"transplantation", "TD"=>"trends", "US"=>"ultrasonography", "UL"=>"ultrastructure", "UR"=>"urine", "UT"=>"utilization", "VE"=>"veterinary", "VI"=>"virology"),
    'e' => array("AB"=>"anomalías", "AD"=>"administración & dosificación", "AE"=>"efectos adversos", "AG"=>"agonistas", "AA"=>"análogos & derivados", "AN"=>"análisis", "AH"=>"anatomía & histología", "AI"=>"antagonistas & Inhibidores", "BI"=>"biosíntesis", "BL"=>"sangre", "BS"=>"irrigación sanguínea", "CF"=>"líquido cefalorraquídeo", "CS"=>"síntesis química", "CI"=>"inducido químicamente", "CH"=>"química", "CL"=>"clasificación", "CO"=>"complicaciones", "CN"=>"congénito", "CT"=>"contraindicaciones", "CY"=>"citología", "DF"=>"deficiencia", "DI"=>"diagnóstico", "DU"=>"uso diagnóstico", "DH"=>"dietoterapia", "DE"=>"efectos de drogas", "DT"=>"quimioterapia", "EC"=>"economía", "ED"=>"educación", "EM"=>"embriología", "EN"=>"enzimología", "EP"=>"epidemiología", "ES"=>"ética", "EH"=>"etnología", "ET"=>"etiología", "GE"=>"genética", "GD"=>"crecimiento & desarrollo", "HI"=>"historia", "IM"=>"inmunología", "IN"=>"lesiones", "IR"=>"inervación", "IS"=>"instrumentación", "IP"=>"aislamiento & purificación", "LJ"=>"legislación & jurisprudencia", "MA"=>"recursos humanos", "ME"=>"metabolismo", "MT"=>"métodos", "MI"=>"microbiología", "MO"=>"mortalidad", "NU"=>"enfermería", "OG"=>"organización & administración", "PS"=>"parasitología", "PY"=>"patogenicidad", "PA"=>"patología", "PK"=>"farmacocinética", "PD"=>"farmacología", "PH"=>"fisiología", "PP"=>"fisiopatología", "PO"=>"envenenamiento", "PL"=>"políticas", "PC"=>"prevención & control", "PX"=>"psicología", "RE"=>"efectos de radiación", "RA"=>"radiografía", "RI"=>"cintigrafía", "RT"=>"radioterapia", "RH"=>"rehabilitación", "SC"=>"secundario", "SE"=>"secreción", "ST"=>"normas", "SN"=>"estadística & datos numéricos", "SD"=>"provisión & distribución", "SU"=>"cirugía", "TU"=>"uso terapéutico", "TH"=>"terapia", "TO"=>"toxicidad", "TM"=>"transmisión", "TR"=>"trasplantación", "TD"=>"tendencias", "US"=>"ultrasonografía", "UL"=>"ultraestructura", "UR"=>"orina", "UT"=>"utilización", "VE"=>"veterinaria", "VI"=>"virología",),
);

function get_descriptors_by_words($words, $lang = ""){

    $words = trim($words);

    global $QUALIFIER_LIST;
    $definition_len = 10000000;

    if(!array_key_exists($lang, $QUALIFIER_LIST)) {
        $QUALIFIER_LIST = $QUALIFIER_LIST['p'];
    } else {
        $QUALIFIER_LIST = $QUALIFIER_LIST[$lang];
    }

    $xmlFile = get_descriptors_from_decs( 'http://decs.bvsalud.org/cgi-bin/mx/cgi=@vmx/decs/?words=' . urlencode($words) . "&lang=" . $lang ); 
    $xmlTree = $xmlFile->xpath("/decsvmx/decsws_response");

    $descriptors = array();
    foreach($xmlTree as $node){

        $definition = "";
        if((string) $node->record_list->record->definition->occ['n'])
            $definition = (string) $node->record_list->record->definition->occ['n'];

        $qualifiers = array();
        foreach($node->record_list->record->allowable_qualifier_list->allowable_qualifier as $qualifier) {
            if(array_key_exists((string) $qualifier, $QUALIFIER_LIST)) {
                $qualifiers[(string) $qualifier] = $QUALIFIER_LIST[(string) $qualifier];
            }
        }

        // print_r($qualifiers);

        // description size
        if(strlen($definition) >= $definition_len) {
            $definition = substr($definition, 0, $definition_len-3) . "...";
        }

        // langs
        $langs = array();
        foreach($node->record_list->record->descriptor_list->descriptor as $descriptor) {
            $langs[(string) $descriptor['lang']] = (string) $descriptor;
        }

        // mfn
        $mfn = (int) $node->record_list->record['mfn'];

        $leaf = true;
        // send the leaf information to de descriptor
        if($node->tree->self->term_list->term['leaf'] != "true") {
            $leaf = false;
        }
        
        // tree id
        $descriptors[(string) $node->tree->self->term_list->term] = array(
            'tree_id' => (string) $node['tree_id'], 
            'definition' => $definition,
            'qualifiers' => $qualifiers,
            'lang' => $langs,
            'synonym' => false,
            'mfn' => $mfn,
            'is_leaf' => $leaf,
        ); 

        foreach($node->record_list->record->synonym_list->synonym as $synonym) {
            $descriptors[ (string) $synonym  ] = array(
                'tree_id' => (string) $node['tree_id'],
                'definition' => $definition,
                'qualifiers' => $qualifiers,
                'lang' => $langs,
                'synonym' => true,
                'mfn' => $mfn,
            );
        }
    }

    return array('descriptors'=>$descriptors);

}

function get_descriptors_lang_by_tree_id($id) {

    $xmlFile = get_descriptors_from_decs( 'http://decs.bvsalud.org/cgi-bin/mx/cgi=@vmx/decs/?tree_id=' . urlencode($id) ); 
    $xmlTree = $xmlFile->xpath("/decsvmx/decsws_response/record_list");

    $result = array();
    foreach($xmlTree as $node) {

        foreach($node->record->descriptor_list->descriptor as $descriptor) {
            $result[(string) $descriptor['lang']] = (string) $descriptor;
        }
    }

    return $result;
}

function get_descriptors_from_decs( $queryUrl ){
  
    // use the curl as default
    if ( function_exists('curl_version') ){

        $ch = curl_init();
        $timeout = 5; // set to zero for no timeout
        curl_setopt ( $ch, CURLOPT_URL, $queryUrl);
        curl_setopt ( $ch, CURLOPT_RETURNTRANSFER, 1 );
        curl_setopt ( $ch, CURLOPT_CONNECTTIMEOUT, $timeout );
        $file_contents = curl_exec($ch);
        curl_close($ch);

    $xmlFile = new SimpleXMLElement($file_contents);
    
    // if dont have the curl use the simplexml_load_file to load the decs xml
    } elseif ( function_exists('simplexml_load_file') == "Enabled" ){

        $xmlFile = simplexml_load_file( $queryUrl );

    } else {
        Throw new Exception('This module need simplexml or curl to get the descriptors from bvs.salude.');
    }

    return $xmlFile;

}

function get_the_wpdecs_terms($id=false) {

    $post = get_post();
    $post_id = $post->ID;
    if($id)
        $post_id = $id;
    

    $wpdecs_terms = get_post_meta($post_id, 'wpdecs_terms', true);
    if($wpdecs_terms) {
        return $wpdecs_terms;
    }

    return array();
}

function the_wpdecs_terms() {

    print '<div class="wpdecs_terms">';
    print '<h2>' . __('DeCS Terms') . '</h2>';
    print '<ul>';

    
    foreach(get_the_wpdecs_terms() as $term) {
        
        // print "<pre>";
        // var_dump($term);

        $print_ql = "";
        if(isset($term['qualifier'])) {
            foreach($term['qualifier'] as $ql) {
                $print_ql .= $ql . '/';
            }
            
            $print_ql = trim($print_ql, "/");
            $print_ql = "($print_ql)";
        }
        
        print "<li>${term['term']} $print_ql</li>";
        
    }

    print '</ul>';
    print '</div>';
}